<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - lcov.info - /home/s1880345/Documents/github/lvb/Solve.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../index.html">top level</a> - <a href="index.html">home/s1880345/Documents/github/lvb</a> - Solve.c<span style="font-size: 80%;"> (source / <a href="Solve.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">lcov.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">231</td>
            <td class="headerCovTableEntry">337</td>
            <td class="headerCovTableEntryLo">68.5 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-04-21 09:25:29</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">3</td>
            <td class="headerCovTableEntry">4</td>
            <td class="headerCovTableEntryMed">75.0 %</td>
          </tr>
          <tr><td><img src="../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* LVB</a>
<span class="lineNum">       2 </span>            : 
<span class="lineNum">       3 </span>            : (c) Copyright 2003-2012 by Daniel Barker
<span class="lineNum">       4 </span>            : (c) Copyright 2013, 2014 by Daniel Barker and 
<span class="lineNum">       5 </span>            : Maximilian Strobl
<span class="lineNum">       6 </span>            : (c) Copyright 2014 by Daniel Barker, Miguel Pinheiro, and Maximilian Strobl
<span class="lineNum">       7 </span>            : (c) Copyright 2015 by Daniel Barker, Miguel Pinheiro, Maximilian Strobl,
<span class="lineNum">       8 </span>            : and Chris Wood.
<span class="lineNum">       9 </span>            : (c) Copyright 2019 by Daniel Barker, Miguel Pinheiro, Joseph Guscott,
<span class="lineNum">      10 </span>            : Fernando Guntoro, Maximilian Strobl and Chris Wood.
<span class="lineNum">      11 </span>            : (c) Copyright 2020 by Joseph Guscott, Daniel Barker, Miguel Pinheiro,
<span class="lineNum">      12 </span>            : Fernando Guntoro, Maximilian Strobl, Chang Sik Kim, Martyn Winn and Chris Wood.
<span class="lineNum">      13 </span>            : 
<span class="lineNum">      14 </span>            : All rights reserved.
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : Redistribution and use in source and binary forms, with or without
<span class="lineNum">      17 </span>            : modification, are permitted provided that the following conditions are met:
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            : 1. Redistributions of source code must retain the above copyright notice, this
<span class="lineNum">      20 </span>            : list of conditions and the following disclaimer.
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span>            : 2. Redistributions in binary form must reproduce the above copyright notice,
<span class="lineNum">      23 </span>            : this list of conditions and the following disclaimer in the documentation
<span class="lineNum">      24 </span>            : and/or other materials provided with the distribution.
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : 3. Neither the name of the copyright holder nor the names of its contributors
<span class="lineNum">      27 </span>            : may be used to endorse or promote products derived from this software without
<span class="lineNum">      28 </span>            : specific prior written permission.
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
<span class="lineNum">      31 </span>            : ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
<span class="lineNum">      32 </span>            : WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<span class="lineNum">      33 </span>            : DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
<span class="lineNum">      34 </span>            : FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
<span class="lineNum">      35 </span>            : DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
<span class="lineNum">      36 </span>            : SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
<span class="lineNum">      37 </span>            : CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<span class="lineNum">      38 </span>            : OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
<span class="lineNum">      39 </span>            : OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : */ 
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            : /* ========== Solve.c - solving functions ========== */
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span>            : #include &quot;DataOperations.h&quot;
<span class="lineNum">      46 </span>            : #include &quot;LVB.h&quot;
<span class="lineNum">      47 </span>            : #include &quot;Solve.h&quot;
<span class="lineNum">      48 </span>            : #include &quot;Print.h&quot;
<a name="49"><span class="lineNum">      49 </span>            : #include &quot;Verbose.h&quot;</a>
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span><span class="lineCov">          7 : static void lenlog(FILE *lengthfp, TREESTACK *bstackp, long iteration, long length, double temperature)</span>
<span class="lineNum">      52 </span>            : /* write a message to file pointer lengthfp; iteration gives current iteration;
<span class="lineNum">      53 </span>            :  * crash verbosely on write error */
<span class="lineNum">      54 </span>            : {
<span class="lineNum">      55 </span><span class="lineCov">          7 :     fprintf(lengthfp, &quot;  %-15.8f%-15ld%-16ld%-15ld\n&quot;, temperature, iteration, bstackp-&gt;next, length);</span>
<span class="lineNum">      56 </span><span class="lineCov">          7 :     if (ferror(lengthfp)){</span>
<span class="lineNum">      57 </span><span class="lineNoCov">          0 :         crash(&quot;file error when logging search progress&quot;);</span>
<span class="lineNum">      58 </span>            :     }
<span class="lineNum">      59 </span>            : 
<span class="lineNum">      60 </span><span class="lineCov">          7 : } /* end lenlog() */</span>
<a name="61"><span class="lineNum">      61 </span>            : </a>
<span class="lineNum">      62 </span>            : #ifdef LVB_MAPREDUCE  
<span class="lineNum">      63 </span><span class="lineNoCov">          0 : long deterministic_hillclimb(Dataptr MSA, TREESTACK *bstackp, const TREESTACK_TREE_BRANCH *const inittree,</span>
<span class="lineNum">      64 </span>            :         Parameters rcstruct, long root, FILE * const lenfp, long *current_iter, Lvb_bool log_progress, 
<span class="lineNum">      65 </span>            :         MISC *misc, MapReduce *mrTreeStack, MapReduce *mrBuffer)
<span class="lineNum">      66 </span>            : #else 
<span class="lineNum">      67 </span>            : long deterministic_hillclimb(Dataptr MSA, TREESTACK *bstackp, const TREESTACK_TREE_BRANCH *const inittree,
<span class="lineNum">      68 </span>            :                 Parameters rcstruct, long root, FILE * const lenfp, long *current_iter, Lvb_bool log_progress)
<span class="lineNum">      69 </span>            : #endif
<span class="lineNum">      70 </span>            : /* perform a deterministic hill-climbing optimization on the tree in inittree,
<span class="lineNum">      71 </span>            :  * using NNI on all internal branches until no changes are accepted; return the
<span class="lineNum">      72 </span>            :  * length of the best tree found; current_iter should give the iteration number
<span class="lineNum">      73 </span>            :  * at the start of this call and will be used in any statistics sent to lenfp,
<span class="lineNum">      74 </span>            :  * and will be updated on return */
<span class="lineNum">      75 </span>            : {
<span class="lineNum">      76 </span>            :     long i;                                                     /* loop counter */
<span class="lineNum">      77 </span>            :     long j;                                                     /* loop counter */
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :     long todo_cnt = 0;                          /* count of internal branches */</span>
<span class="lineNum">      79 </span>            :     long len;                                           /* current length */
<span class="lineNum">      80 </span>            :     long lendash;                                       /* length of proposed new config */
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :     long rootdash = root;                       /* root of proposed new config */</span>
<span class="lineNum">      82 </span>            :     long deltalen;                                      /* change in length */
<span class="lineNum">      83 </span>            :     Lvb_bool newtree;                           /* accepted a new configuration */
<span class="lineNum">      84 </span>            :     TREESTACK_TREE_BRANCH *p_current_tree;                      /* current configuration */
<span class="lineNum">      85 </span>            :     TREESTACK_TREE_BRANCH *p_proposed_tree;             /* proposed new configuration */
<span class="lineNum">      86 </span>            :     unsigned int *todo;                         /* array of internal branch numbers */
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :     Lvb_bool leftright[] = { LVB_FALSE, LVB_TRUE }; /* to loop through left and right */</span>
<span class="lineNum">      88 </span>            :     long *p_todo_arr; /* [MAX_BRANCHES + 1];     list of &quot;dirty&quot; branch nos */
<span class="lineNum">      89 </span>            :     long *p_todo_arr_sum_changes; /*used in openMP, to sum the partial changes */
<span class="lineNum">      90 </span>            :     int *p_runs;                                /*used in openMP, 0 if not run yet, 1 if it was processed */
<span class="lineNum">      91 </span>            : 
<span class="lineNum">      92 </span>            :         #ifdef LVB_MAPREDUCE  
<span class="lineNum">      93 </span>            :                 int *total_count;
<span class="lineNum">      94 </span>            :             int check_cmp;
<span class="lineNum">      95 </span>            :         #endif
<span class="lineNum">      96 </span>            : 
<span class="lineNum">      97 </span>            :     /* &quot;local&quot; dynamic heap memory */
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :     p_current_tree = treealloc(MSA, LVB_TRUE);</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :     p_proposed_tree = treealloc(MSA, LVB_TRUE);</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :     todo = (unsigned int *) alloc(MSA-&gt;numberofpossiblebranches * sizeof(unsigned int), &quot;old parent alloc&quot;);</span>
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :     treecopy(MSA, p_current_tree, inittree, LVB_TRUE);      /* current configuration */</span>
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :         alloc_memory_to_getplen(MSA, &amp;p_todo_arr, &amp;p_todo_arr_sum_changes, &amp;p_runs);</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :         len = getplen(MSA, p_current_tree, rcstruct, root, p_todo_arr, p_todo_arr_sum_changes, p_runs);</span>
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span>            :     /* identify internal branches */
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :     for (i = MSA-&gt;n; i &lt; MSA-&gt;numberofpossiblebranches; i++) todo[todo_cnt++] = i;</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :     lvb_assert(todo_cnt == MSA-&gt;numberofpossiblebranches - MSA-&gt;n);</span>
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :     do {</span>
<span class="lineNum">     111 </span>            :                 newtree = LVB_FALSE;
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :                 for (i = 0; i &lt; todo_cnt; i++) {</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :                         for (j = 0; j &lt; 2; j++) {</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :                                 mutate_deterministic(MSA, p_proposed_tree, p_current_tree, root, todo[i], leftright[j]);</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :                                 lendash = getplen(MSA, p_proposed_tree, rcstruct, rootdash, p_todo_arr, p_todo_arr_sum_changes, p_runs);</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :                                 lvb_assert (lendash &gt;= 1L);</span>
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :                                 deltalen = lendash - len;</span>
<span class="lineNum">     118 </span>            :                                 #ifdef LVB_MAPREDUCE  
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :                                 MPI_Bcast(&amp;deltalen, 1, MPI_LONG, 0,    MPI_COMM_WORLD);</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :                                         MPI_Bcast(&amp;lendash,  1, MPI_LONG, 0,    MPI_COMM_WORLD);</span>
<span class="lineNum">     121 </span>            : 
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :                                         if (deltalen &lt;= 0) {</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :                                                 if (deltalen &lt; 0)  /* very best so far */</span>
<span class="lineNum">     124 </span>            :                                                 {
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :                                                         ClearTreestack(bstackp);</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :                                                         PushCurrentTreeToStack(MSA, bstackp, p_proposed_tree, rootdash, LVB_FALSE);</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :                                                         misc-&gt;ID = bstackp-&gt;next;</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :                                                         misc-&gt;SB = 1;</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :                                                         tree_setpush(MSA, p_proposed_tree, rootdash, mrTreeStack, misc);</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :                                                         len = lendash;</span>
<span class="lineNum">     131 </span>            :                                                 } else {
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :                                                   misc-&gt;SB = 0;</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :                                                   tree_setpush(MSA, p_proposed_tree, rootdash, mrBuffer, misc);</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :                                                   mrBuffer-&gt;add(mrTreeStack);</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :                                                   mrBuffer-&gt;collate(NULL);</span>
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :                                                   misc-&gt;count = (int *) alloc( (bstackp-&gt;next+1) * sizeof(int), &quot;int array for tree comp using MR&quot;);</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :                                                   total_count = (int *) alloc( (bstackp-&gt;next+1) * sizeof(int), &quot;int array for tree comp using MR&quot;);</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :                                                   for(int i=0; i&lt;=bstackp-&gt;next; i++) misc-&gt;count[i] = 0;</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :                                                   mrBuffer-&gt;reduce(reduce_count, misc);</span>
<span class="lineNum">     142 </span>            : 
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :                                                   for(int i=0; i&lt;=bstackp-&gt;next; i++) total_count[i] = 0;</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :                                                   MPI_Reduce( misc-&gt;count, total_count, bstackp-&gt;next+1, MPI_INT, MPI_SUM, 0, MPI_COMM_WORLD );</span>
<span class="lineNum">     145 </span>            : 
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :                                                   check_cmp = 1;</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :                                                   if (misc-&gt;rank == 0) { /* sum to root process */</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :                                                         for(int i=1; i&lt;=bstackp-&gt;next; i++) {</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :                                                                 if (misc-&gt;nsets == total_count[i]) {</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :                                                                         check_cmp = 0; /* different */</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :                                                                         break;</span>
<span class="lineNum">     152 </span>            :                                                                 }
<span class="lineNum">     153 </span>            :                                                         }
<span class="lineNum">     154 </span>            :                                                   }
<span class="lineNum">     155 </span>            : 
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :                                                   MPI_Barrier(MPI_COMM_WORLD);</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :                                                   MPI_Bcast(&amp;check_cmp, 1, MPI_INT, 0,    MPI_COMM_WORLD);</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :                                                   if (check_cmp == 0) {</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :                                                                 misc-&gt;SB = 1;</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :                                                                 tree_setpush(MSA, p_proposed_tree, rootdash, mrBuffer, misc);</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :                                                                 mrTreeStack-&gt;add(mrBuffer);</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :                                                         if (CompareTreeToTreestack(MSA, bstackp, p_proposed_tree, rootdash, LVB_FALSE) == 1) {</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :                                                                 misc-&gt;ID = bstackp-&gt;next;</span>
<span class="lineNum">     164 </span>            : 
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :                                                                 newtree = LVB_TRUE;</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :                                                                 SwapTrees(&amp;p_current_tree, &amp;root, &amp;p_proposed_tree, &amp;rootdash);</span>
<span class="lineNum">     167 </span>            :                                                         }
<span class="lineNum">     168 </span>            :                                                   }
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :                                                   free(misc-&gt;count);</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :                                                   free(total_count);</span>
<span class="lineNum">     171 </span>            :                                                 }
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span>            :                                         #else 
<span class="lineNum">     174 </span>            :                                         if (deltalen &lt;= 0) {
<span class="lineNum">     175 </span>            :                                         if (deltalen &lt; 0)  /* very best so far */
<span class="lineNum">     176 </span>            :                                         {
<span class="lineNum">     177 </span>            :                                                 ClearTreestack(bstackp);
<span class="lineNum">     178 </span>            :                                                 len = lendash;
<span class="lineNum">     179 </span>            :                                         }
<span class="lineNum">     180 </span>            :                                                 #ifdef LVB_HASH
<span class="lineNum">     181 </span>            :                                                         if (CompareHashTreeToHashstack(MSA, bstackp, p_proposed_tree, rootdash, LVB_FALSE) == 1) 
<span class="lineNum">     182 </span>            :                                                 #else
<span class="lineNum">     183 </span>            :                                                         if (CompareTreeToTreestack(MSA, bstackp, p_proposed_tree, rootdash, LVB_FALSE) == 1) 
<span class="lineNum">     184 </span>            :                                                 #endif
<span class="lineNum">     185 </span>            :                                         {
<span class="lineNum">     186 </span>            :                                                 newtree = LVB_TRUE;
<span class="lineNum">     187 </span>            :                                                 SwapTrees(&amp;p_current_tree, &amp;root, &amp;p_proposed_tree, &amp;rootdash);
<span class="lineNum">     188 </span>            :                                         }
<span class="lineNum">     189 </span>            :                                         
<span class="lineNum">     190 </span>            :                                         #endif
<span class="lineNum">     191 </span>            :                                 }
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :                                 if ((log_progress == LVB_TRUE) &amp;&amp; ((*current_iter % STAT_LOG_INTERVAL) == 0)) {</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :                                         lenlog(lenfp, bstackp, *current_iter, len, 0);</span>
<span class="lineNum">     194 </span>            :                                 }
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :                                 *current_iter += 1;</span>
<span class="lineNum">     196 </span>            :                         }
<span class="lineNum">     197 </span>            :                 }
<span class="lineNum">     198 </span>            :     } while (newtree == LVB_TRUE);
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span>            :     /* free &quot;local&quot; dynamic heap memory */
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :     free_memory_to_getplen(&amp;p_todo_arr, &amp;p_todo_arr_sum_changes, &amp;p_runs);</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :     free(p_current_tree);</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :     free(p_proposed_tree);</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :     free(todo);</span>
<span class="lineNum">     205 </span>            : 
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :     return len;</span>
<span class="lineNum">     207 </span>            : } /* end deterministic_hillclimb */
<a name="208"><span class="lineNum">     208 </span>            : </a>
<span class="lineNum">     209 </span>            : #ifdef LVB_MAPREDUCE  
<span class="lineNum">     210 </span><span class="lineCov">          8 : long Anneal(Dataptr MSA, TREESTACK *bstackp, TREESTACK *treevo, const TREESTACK_TREE_BRANCH *const inittree, Parameters rcstruct,</span>
<span class="lineNum">     211 </span>            :         long root, const double t0, const long maxaccept, const long maxpropose,
<span class="lineNum">     212 </span>            :         const long maxfail, FILE *const lenfp, long *current_iter,
<span class="lineNum">     213 </span>            :         Lvb_bool log_progress, MISC *misc, MapReduce *mrTreeStack, MapReduce *mrBuffer)
<span class="lineNum">     214 </span>            : 
<span class="lineNum">     215 </span>            : #else
<span class="lineNum">     216 </span>            : long Anneal(Dataptr MSA, TREESTACK *bstackp, TREESTACK *treevo, const TREESTACK_TREE_BRANCH *const inittree, Parameters rcstruct,
<span class="lineNum">     217 </span>            :         long root, const double t0, const long maxaccept, const long maxpropose,
<span class="lineNum">     218 </span>            :         const long maxfail, FILE *const lenfp, long *current_iter,
<span class="lineNum">     219 </span>            :         Lvb_bool log_progress)
<span class="lineNum">     220 </span>            : 
<span class="lineNum">     221 </span>            : #endif
<span class="lineNum">     222 </span>            : /* seek parsimonious tree from initial tree in inittree (of root root)
<span class="lineNum">     223 </span>            :  * with initial temperature t0, and subsequent temperatures obtained by
<span class="lineNum">     224 </span>            :  * multiplying the current temperature by (t1 / t0) ** n * t0 where n is
<span class="lineNum">     225 </span>            :  * the ordinal number of this temperature, after at least maxaccept changes
<span class="lineNum">     226 </span>            :  * have been accepted or maxpropose changes have been proposed, whichever is
<span class="lineNum">     227 </span>            :  * sooner;
<span class="lineNum">     228 </span>            :  * return the length of the best tree(s) found after maxfail consecutive
<span class="lineNum">     229 </span>            :  * temperatures have led to no new accepted solution;
<span class="lineNum">     230 </span>            :  * lenfp is for output of current tree length and associated details;
<span class="lineNum">     231 </span>            :  * *current_iter should give the iteration number at the start of this call and
<span class="lineNum">     232 </span>            :  * will be used in any statistics sent to lenfp, and will be updated on
<span class="lineNum">     233 </span>            :  * return */
<span class="lineNum">     234 </span>            : {
<span class="lineNum">     235 </span><span class="lineCov">          1 :     long accepted = 0;          /* changes accepted */</span>
<span class="lineNum">     236 </span>            :     Lvb_bool dect;              /* should decrease temperature */
<span class="lineNum">     237 </span>            :     double deltah;              /* change in energy (1 - C.I.) */
<span class="lineNum">     238 </span>            :     long deltalen;              /* change in length with new tree */
<span class="lineNum">     239 </span><span class="lineCov">          1 :     long failedcnt = 0;         /* &quot;failed count&quot; for temperatures */</span>
<span class="lineNum">     240 </span><span class="lineCov">          1 :     long iter = 0;              /* iteration of mutate/evaluate loop */</span>
<span class="lineNum">     241 </span>            :     long len;                   /* length of current tree */
<span class="lineNum">     242 </span>            :     long lenbest;               /* bet length found so far */
<span class="lineNum">     243 </span>            :     long lendash;               /* length of proposed new tree */
<span class="lineNum">     244 </span>            :         double ln_t;            /* ln(current temperature) */
<span class="lineNum">     245 </span><span class="lineCov">          1 :     long t_n = 0;               /* ordinal number of current temperature */</span>
<span class="lineNum">     246 </span>            :     double pacc;                /* prob. of accepting new config. */
<span class="lineNum">     247 </span><span class="lineCov">          1 :     long proposed = 0;          /* trees proposed */</span>
<span class="lineNum">     248 </span>            :     double r_lenmin;            /* minimum length for any tree */
<span class="lineNum">     249 </span>            :     long rootdash;              /* root of new configuration */
<span class="lineNum">     250 </span><span class="lineCov">          1 :     double t = t0;              /* current temperature */</span>
<span class="lineNum">     251 </span><span class="lineCov">          1 :     double grad_geom = 0.99;            /* &quot;gradient&quot; of the geometric schedule */</span>
<span class="lineNum">     252 </span><span class="lineCov">          1 :         double grad_linear = 10 * LVB_EPS; /* gradient of the linear schedule */</span>
<span class="lineNum">     253 </span>            :         /* double grad_linear = 10 * LVB_EPS; */ /* gradient of the linear schedule */
<span class="lineNum">     254 </span>            :     TREESTACK_TREE_BRANCH *p_current_tree;                      /* current configuration */
<span class="lineNum">     255 </span>            :     TREESTACK_TREE_BRANCH *p_proposed_tree;             /* proposed new configuration */
<span class="lineNum">     256 </span>            :     long *p_todo_arr; /* [MAX_BRANCHES + 1];     list of &quot;dirty&quot; branch nos */
<span class="lineNum">     257 </span>            :     long *p_todo_arr_sum_changes; /*used in openMP, to sum the partial changes */
<span class="lineNum">     258 </span>            :     int *p_runs;                                /*used in openMP, 0 if not run yet, 1 if it was processed */
<span class="lineNum">     259 </span>            :         #ifdef LVB_MAPREDUCE  
<span class="lineNum">     260 </span>            :                 int *total_count;
<span class="lineNum">     261 </span>            :             int check_cmp;
<span class="lineNum">     262 </span>            :         #endif
<span class="lineNum">     263 </span>            : 
<span class="lineNum">     264 </span>            :     /* variables that could calculate immediately */
<span class="lineNum">     265 </span><span class="lineCov">          1 :     const double log_wrapper_LVB_EPS = log_wrapper(LVB_EPS);</span>
<span class="lineNum">     266 </span><span class="lineCov">          1 :     const double log_wrapper_grad_geom = log_wrapper(grad_geom);</span>
<span class="lineNum">     267 </span><span class="lineCov">          1 :     const double log_wrapper_t0 =  log_wrapper(t0);</span>
<span class="lineNum">     268 </span>            :     /* REND variables that could calculate immediately */
<span class="lineNum">     269 </span>            : 
<span class="lineNum">     270 </span><span class="lineCov">          1 :          long w_changes_prop = 0;</span>
<span class="lineNum">     271 </span><span class="lineCov">          1 :         long w_changes_acc = 0;  </span>
<span class="lineNum">     272 </span><span class="lineCov">          1 :     p_proposed_tree = treealloc(MSA, LVB_TRUE);</span>
<span class="lineNum">     273 </span><span class="lineCov">          1 :     p_current_tree = treealloc(MSA, LVB_TRUE);</span>
<span class="lineNum">     274 </span>            : 
<span class="lineNum">     275 </span><span class="lineCov">          1 :     treecopy(MSA, p_current_tree, inittree, LVB_TRUE);  /* current configuration */</span>
<span class="lineNum">     276 </span>            : 
<span class="lineNum">     277 </span><span class="lineCov">          1 :     alloc_memory_to_getplen(MSA, &amp;p_todo_arr, &amp;p_todo_arr_sum_changes, &amp;p_runs);</span>
<span class="lineNum">     278 </span><span class="lineCov">          1 :     len = getplen(MSA, p_current_tree, rcstruct, root, p_todo_arr, p_todo_arr_sum_changes, p_runs);</span>
<span class="lineNum">     279 </span><span class="lineCov">          1 :     dect = LVB_FALSE;           /* made LVB_TRUE as necessary at end of loop */</span>
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span><span class="lineCov">          1 :     lvb_assert( ((float) t &gt;= (float) LVB_EPS) &amp;&amp; (t &lt;= 1.0) &amp;&amp; (grad_geom &gt;= LVB_EPS) &amp;&amp; (grad_linear &gt;= LVB_EPS));</span>
<span class="lineNum">     282 </span>            : 
<span class="lineNum">     283 </span><span class="lineCov">          1 :     lenbest = len;</span>
<span class="lineNum">     284 </span>            : 
<span class="lineNum">     285 </span>            :         #ifdef LVB_HASH
<span class="lineNum">     286 </span>            :                 CompareHashTreeToHashstack(MSA, bstackp, inittree, root, LVB_FALSE);    /* init. tree initially best */
<span class="lineNum">     287 </span>            :         #else
<span class="lineNum">     288 </span><span class="lineCov">          1 :                 CompareTreeToTreestack(MSA, bstackp, inittree, root, LVB_FALSE);        /* init. tree initially best */  </span>
<span class="lineNum">     289 </span>            :         #endif
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span><span class="lineCov">          1 :         double trops_counter[3] = {1,1,1};</span>
<span class="lineNum">     292 </span><span class="lineCov">          1 :         double trops_probs[3] = {0,0,0};</span>
<span class="lineNum">     293 </span><span class="lineCov">          1 :         long trops_total = trops_counter[0]+trops_counter[1]+trops_counter[2];</span>
<span class="lineNum">     294 </span><span class="lineCov">          1 :         long trops_id = 0;</span>
<span class="lineNum">     295 </span>            :         
<span class="lineNum">     296 </span>            : 
<span class="lineNum">     297 </span><span class="lineCov">          1 :     if ((log_progress == LVB_TRUE) &amp;&amp; (*current_iter == 0)) {</span>
<span class="lineNum">     298 </span>            : 
<span class="lineNum">     299 </span><span class="lineCov">          1 :         printf(&quot;\n--------------------------------------------------------&quot;);</span>
<span class="lineNum">     300 </span><span class="lineCov">          1 :         fprintf(lenfp, &quot;\n  Temperature:   Rearrangement: TreeStack size: Length:\n&quot;);</span>
<span class="lineNum">     301 </span><span class="lineCov">          1 :         printf(&quot;--------------------------------------------------------\n&quot;);</span>
<span class="lineNum">     302 </span>            :         }
<span class="lineNum">     303 </span>            :                 #ifdef LVB_MAPREDUCE  
<span class="lineNum">     304 </span><span class="lineCov">          1 :                 MPI_Bcast(&amp;lenbest,  1, MPI_LONG, 0, MPI_COMM_WORLD);</span>
<span class="lineNum">     305 </span><span class="lineCov">          1 :                 misc-&gt;ID = bstackp-&gt;next;</span>
<span class="lineNum">     306 </span><span class="lineCov">          1 :                 misc-&gt;SB = 1;</span>
<span class="lineNum">     307 </span><span class="lineCov">          1 :                 tree_setpush(MSA, inittree, root, mrTreeStack, misc);</span>
<span class="lineNum">     308 </span>            :                 #endif
<span class="lineNum">     309 </span>            : 
<span class="lineNum">     310 </span>            :                 /*Writing output to table.tsv*/
<span class="lineNum">     311 </span>            :     FILE * pFile;
<span class="lineNum">     312 </span><span class="lineCov">          1 :     char change[10]=&quot;&quot;;</span>
<span class="lineNum">     313 </span><span class="lineCov">          1 :     if ((log_progress == LVB_TRUE) &amp;&amp; (*current_iter == 0)) {</span>
<span class="lineNum">     314 </span><span class="lineCov">          1 :                 if (rcstruct.verbose == LVB_TRUE)</span>
<span class="lineNum">     315 </span>            :                 {
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :            pFile = fopen (&quot;changeAccepted.tsv&quot;,&quot;w&quot;);</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :            fprintf (pFile, &quot;Iteration\tAlgorithm\tAccepted\tLength\tTemperature\tTreestack Size\n&quot;);</span>
<span class="lineNum">     318 </span>            :         }
<span class="lineNum">     319 </span>            :         }
<span class="lineNum">     320 </span><span class="lineCov">          1 :         r_lenmin = (double) MSA-&gt;min_len_tree;</span>
<span class="lineNum">     321 </span>            :         
<span class="lineNum">     322 </span>            :            while (1) {
<span class="lineNum">     323 </span><span class="lineCov">     354050 :         int changeAcc = 0;</span>
<span class="lineNum">     324 </span><span class="lineCov">     354050 :         *current_iter += 1;</span>
<span class="lineNum">     325 </span>            :                 /* occasionally re-root, to prevent influence from root position */
<span class="lineNum">     326 </span><span class="lineCov">     354050 :                 if ((*current_iter % REROOT_INTERVAL) == 0){</span>
<span class="lineNum">     327 </span><span class="lineCov">        354 :                         root = arbreroot(MSA, p_current_tree, root);</span>
<span class="lineNum">     328 </span><span class="lineCov">        354 :                         if ((log_progress == LVB_TRUE) &amp;&amp; ((*current_iter % STAT_LOG_INTERVAL) == 0)) {</span>
<span class="lineNum">     329 </span><span class="lineCov">         14 :                         lenlog(lenfp, bstackp, *current_iter, len, t);</span>
<span class="lineNum">     330 </span>            :                 }
<span class="lineNum">     331 </span>            :                 }
<span class="lineNum">     332 </span>            : 
<span class="lineNum">     333 </span><span class="lineCov">     354050 :                 lvb_assert(t &gt; DBL_EPSILON);</span>
<span class="lineNum">     334 </span>            : 
<span class="lineNum">     335 </span>            :                 /* mutation: alternate between the two mutation functions */
<span class="lineNum">     336 </span><span class="lineCov">     354050 :                 rootdash = root;</span>
<span class="lineNum">     337 </span><span class="lineCov">     354050 :                 if (rcstruct.algorithm_selection ==2)</span>
<span class="lineNum">     338 </span>            :                 {
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :                         trops_total = trops_counter[0]+trops_counter[1]+trops_counter[2];</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :                 trops_probs[0]=trops_counter[0]/trops_total;</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :                 trops_probs[1]=trops_counter[1]/trops_total;</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :                 trops_probs[2]=trops_counter[2]/trops_total; </span>
<span class="lineNum">     343 </span>            :                 }
<span class="lineNum">     344 </span>            : 
<span class="lineNum">     345 </span><span class="lineCov">     354050 :                   if (rcstruct.algorithm_selection &gt;= 1)</span>
<span class="lineNum">     346 </span>            :                   {
<span class="lineNum">     347 </span><span class="lineCov">     354050 :                 double random_val = uni();</span>
<span class="lineNum">     348 </span><span class="lineCov">     354050 :                 if (random_val &lt; trops_probs[0]) {</span>
<span class="lineNum">     349 </span><span class="lineCov">     125946 :                         mutate_nni(MSA, p_proposed_tree, p_current_tree, root); /* local change */</span>
<span class="lineNum">     350 </span><span class="lineCov">     125946 :                         strcpy(change,&quot;NNI&quot;);</span>
<span class="lineNum">     351 </span><span class="lineCov">     125946 :                         if (rcstruct.algorithm_selection == 2)</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :                         trops_id = 0;</span>
<span class="lineNum">     353 </span>            :                 }
<span class="lineNum">     354 </span><span class="lineCov">     228104 :         else if (random_val &lt; trops_probs[0] + trops_probs[1]) {</span>
<span class="lineNum">     355 </span><span class="lineCov">     125304 :                 mutate_spr(MSA, p_proposed_tree, p_current_tree, root); /* global change */</span>
<span class="lineNum">     356 </span><span class="lineCov">     125304 :             strcpy(change,&quot;SPR&quot;);</span>
<span class="lineNum">     357 </span><span class="lineCov">     125304 :                         if (rcstruct.algorithm_selection == 2)</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :                         trops_id = 1;</span>
<span class="lineNum">     359 </span>            :         }
<span class="lineNum">     360 </span>            :         else {
<span class="lineNum">     361 </span><span class="lineCov">     102800 :                 mutate_tbr(MSA, p_proposed_tree, p_current_tree, root); /* global change */</span>
<span class="lineNum">     362 </span><span class="lineCov">     102800 :             strcpy(change,&quot;TBR&quot;);</span>
<span class="lineNum">     363 </span><span class="lineCov">     102800 :                         if (rcstruct.algorithm_selection == 2)</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :                         trops_id = 2;</span>
<span class="lineNum">     365 </span>            :         }
<span class="lineNum">     366 </span>            :                   }
<span class="lineNum">     367 </span>            :                 else
<span class="lineNum">     368 </span>            :                 {
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :                 if (iter &amp; 0x01) { mutate_spr(MSA, p_proposed_tree, p_current_tree, root);  /* global change */</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :                 strcpy(change,&quot;SPR&quot;); }</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :                 else { mutate_nni (MSA, p_proposed_tree, p_current_tree, root); /* local change */</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :                 strcpy(change,&quot;NNI&quot;); }</span>
<span class="lineNum">     373 </span>            :                 }
<span class="lineNum">     374 </span>            :                 
<span class="lineNum">     375 </span><span class="lineCov">     354050 :                 lendash = getplen(MSA, p_proposed_tree, rcstruct, rootdash, p_todo_arr, p_todo_arr_sum_changes, p_runs);</span>
<span class="lineNum">     376 </span><span class="lineCov">     354050 :                 lvb_assert (lendash &gt;= 1L);</span>
<span class="lineNum">     377 </span><span class="lineCov">     354050 :                 deltalen = lendash - len;</span>
<span class="lineNum">     378 </span><span class="lineCov">     354050 :                 deltah = (r_lenmin / (double) len) - (r_lenmin / (double) lendash);</span>
<span class="lineNum">     379 </span><span class="lineCov">     354050 :                 if (deltah &gt; 1.0) deltah = 1.0; /* MinimumTreeLength() problem with ambiguous sites */</span>
<span class="lineNum">     380 </span>            : 
<span class="lineNum">     381 </span>            :                 #ifdef LVB_MAPREDUCE  
<span class="lineNum">     382 </span><span class="lineCov">     354050 :                         MPI_Bcast(&amp;deltalen, 1, MPI_LONG, 0, MPI_COMM_WORLD);</span>
<span class="lineNum">     383 </span><span class="lineCov">     354050 :                         MPI_Bcast(&amp;deltah,   1, MPI_LONG, 0, MPI_COMM_WORLD);</span>
<span class="lineNum">     384 </span><span class="lineCov">     354050 :                         MPI_Bcast(&amp;lendash,  1, MPI_LONG, 0, MPI_COMM_WORLD);</span>
<span class="lineNum">     385 </span>            :                 #endif
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span><span class="lineCov">     354050 :                 if (deltalen &lt;= 0)   /* accept the change */</span>
<span class="lineNum">     388 </span>            :                 {
<span class="lineNum">     389 </span>            :                                 #ifdef LVB_MAPREDUCE  
<span class="lineNum">     390 </span><span class="lineCov">      51961 :                                                         if (lendash &lt;= lenbest)      /* store tree if new */</span>
<span class="lineNum">     391 </span>            :                         {
<span class="lineNum">     392 </span><span class="lineCov">       1035 :                                         if (lendash &lt; lenbest) {</span>
<span class="lineNum">     393 </span><span class="lineCov">        509 :                                                 ClearTreestack(bstackp);</span>
<span class="lineNum">     394 </span><span class="lineCov">        509 :                                                 mrTreeStack-&gt;map( mrTreeStack, map_clean, NULL );</span>
<span class="lineNum">     395 </span>            : 
<span class="lineNum">     396 </span><span class="lineCov">        509 :                                                 if (CompareTreeToTreestack(MSA, bstackp, p_proposed_tree, rootdash, LVB_FALSE) == 1){</span>
<span class="lineNum">     397 </span><span class="lineCov">        509 :                                                 misc-&gt;ID = bstackp-&gt;next;</span>
<span class="lineNum">     398 </span>            : 
<span class="lineNum">     399 </span><span class="lineCov">        509 :                                             misc-&gt;SB = 1;</span>
<span class="lineNum">     400 </span><span class="lineCov">        509 :                                                 tree_setpush(MSA, p_proposed_tree, rootdash, mrTreeStack, misc);</span>
<span class="lineNum">     401 </span>            : 
<span class="lineNum">     402 </span><span class="lineCov">        509 :                                                 accepted++;</span>
<span class="lineNum">     403 </span><span class="lineCov">        509 :                                                 MPI_Bcast(&amp;accepted,  1, MPI_LONG, 0, MPI_COMM_WORLD);</span>
<span class="lineNum">     404 </span>            :                                                 }
<span class="lineNum">     405 </span>            : 
<span class="lineNum">     406 </span><span class="lineCov">        509 :                                                 MPI_Barrier(MPI_COMM_WORLD);</span>
<span class="lineNum">     407 </span>            :                                         } else {
<span class="lineNum">     408 </span>            : 
<span class="lineNum">     409 </span><span class="lineCov">        526 :                             misc-&gt;SB = 0;</span>
<span class="lineNum">     410 </span><span class="lineCov">        526 :                                                 tree_setpush(MSA, p_proposed_tree, rootdash, mrBuffer, misc);</span>
<span class="lineNum">     411 </span><span class="lineCov">        526 :                                                 mrBuffer-&gt;add(mrTreeStack);</span>
<span class="lineNum">     412 </span><span class="lineCov">        526 :                                                 mrBuffer-&gt;collate(NULL);</span>
<span class="lineNum">     413 </span>            : 
<span class="lineNum">     414 </span><span class="lineCov">        526 :                                                 misc-&gt;count = (int *) alloc( (bstackp-&gt;next+1) * sizeof(int), &quot;int array for tree comp using MR&quot;);</span>
<span class="lineNum">     415 </span><span class="lineCov">        526 :                                                 total_count = (int *) alloc( (bstackp-&gt;next+1) * sizeof(int), &quot;int array for tree comp using MR&quot;);</span>
<span class="lineNum">     416 </span>            : 
<span class="lineNum">     417 </span><span class="lineCov">      15472 :                                                 for(int i=0; i&lt;=misc-&gt;ID; i++) misc-&gt;count[i] = 0;</span>
<span class="lineNum">     418 </span>            :                                                 /* cerr &lt;&lt; &quot;Reduce ********************* &quot; &lt;&lt; endl; */
<span class="lineNum">     419 </span>            :                                                 /* cerr &lt;&lt; &quot;Reduce ********************* &quot; &lt;&lt; endl; */
<span class="lineNum">     420 </span><span class="lineCov">        526 :                                                 mrBuffer-&gt;reduce(reduce_count, misc);</span>
<span class="lineNum">     421 </span>            :                                                 /* cerr &lt;&lt; &quot;END Reduce ********************* &quot; &lt;&lt; endl; */
<span class="lineNum">     422 </span>            :                                                 /* cerr &lt;&lt; &quot;END Reduce ********************* &quot; &lt;&lt; endl; */
<span class="lineNum">     423 </span><span class="lineCov">      15472 :                                                 for(int i=0; i&lt;=misc-&gt;ID; i++) total_count[i] = 0;</span>
<span class="lineNum">     424 </span><span class="lineCov">        526 :                                                 MPI_Reduce( misc-&gt;count, total_count, misc-&gt;ID+1, MPI_INT, MPI_SUM, 0, MPI_COMM_WORLD );</span>
<span class="lineNum">     425 </span>            : 
<span class="lineNum">     426 </span><span class="lineCov">        526 :                                                 check_cmp = 1;</span>
<span class="lineNum">     427 </span><span class="lineCov">        526 :                                                 if (misc-&gt;rank == 0) {</span>
<span class="lineNum">     428 </span><span class="lineCov">       8002 :                                                         for(int i=1; i&lt;=misc-&gt;ID; i++) {</span>
<span class="lineNum">     429 </span>            :                                                         //      if (misc-&gt;nsets == total_count[i]) {
<span class="lineNum">     430 </span><span class="lineCov">       8288 :                                                                 if (total_count[0] == total_count[i]) {</span>
<span class="lineNum">     431 </span><span class="lineCov">        286 :                                                                         check_cmp = 0;</span>
<span class="lineNum">     432 </span><span class="lineCov">        286 :                                                                         break;</span>
<span class="lineNum">     433 </span>            :                                                                 }
<span class="lineNum">     434 </span>            :                                                         }
<span class="lineNum">     435 </span>            :                                                 }
<span class="lineNum">     436 </span>            : 
<span class="lineNum">     437 </span><span class="lineCov">        526 :                                                 MPI_Barrier(MPI_COMM_WORLD);</span>
<span class="lineNum">     438 </span><span class="lineCov">        526 :                                                 MPI_Bcast(&amp;check_cmp, 1, MPI_INT, 0,    MPI_COMM_WORLD);</span>
<span class="lineNum">     439 </span><span class="lineCov">        526 :                                                 if (check_cmp == 1) {</span>
<span class="lineNum">     440 </span>            : 
<span class="lineNum">     441 </span><span class="lineCov">        240 :                                                         if (CompareTreeToTreestack(MSA, bstackp, p_proposed_tree, rootdash, LVB_FALSE) == 1){</span>
<span class="lineNum">     442 </span><span class="lineCov">        240 :                                                         misc-&gt;ID = bstackp-&gt;next;</span>
<span class="lineNum">     443 </span>            : 
<span class="lineNum">     444 </span><span class="lineCov">        240 :                                                         misc-&gt;SB = 1;</span>
<span class="lineNum">     445 </span><span class="lineCov">        240 :                                                         tree_setpush(MSA, p_proposed_tree, rootdash, mrBuffer, misc);</span>
<span class="lineNum">     446 </span><span class="lineCov">        240 :                                                         mrTreeStack-&gt;add(mrBuffer);</span>
<span class="lineNum">     447 </span><span class="lineCov">        240 :                                                         accepted++;</span>
<span class="lineNum">     448 </span><span class="lineCov">        240 :                                                         MPI_Bcast(&amp;accepted,  1, MPI_LONG, 0, MPI_COMM_WORLD);</span>
<span class="lineNum">     449 </span>            :                                                         }
<span class="lineNum">     450 </span>            :                                                 }
<span class="lineNum">     451 </span>            : 
<span class="lineNum">     452 </span><span class="lineCov">        526 :                                                 free(misc-&gt;count);</span>
<span class="lineNum">     453 </span><span class="lineCov">        526 :                                                 free(total_count);</span>
<span class="lineNum">     454 </span>            :                                                 
<span class="lineNum">     455 </span>            :                                         }
<span class="lineNum">     456 </span>            : 
<span class="lineNum">     457 </span>            :                                 }
<span class="lineNum">     458 </span>            :                                 #else
<span class="lineNum">     459 </span>            :                                                                 if (lendash &lt;= lenbest)      /* store tree if new */
<span class="lineNum">     460 </span>            :                         {
<span class="lineNum">     461 </span>            :                                 /*printf(&quot;%ld\n&quot;, *current_iter);*/
<span class="lineNum">     462 </span>            :                                 if (lendash &lt; lenbest) {
<span class="lineNum">     463 </span>            :                                         ClearTreestack(bstackp);        /* discard old bests */
<span class="lineNum">     464 </span>            :                                 }
<span class="lineNum">     465 </span>            :                                         #ifdef LVB_HASH
<span class="lineNum">     466 </span>            :                                                 if(CompareHashTreeToHashstack(MSA, bstackp, p_proposed_tree, rootdash, LVB_FALSE) == 1)
<span class="lineNum">     467 </span>            :                                         #else
<span class="lineNum">     468 </span>            :                                                 if(CompareTreeToTreestack(MSA, bstackp, p_proposed_tree, rootdash, LVB_FALSE) == 1)
<span class="lineNum">     469 </span>            :                                         #endif
<span class="lineNum">     470 </span>            :                                 {
<span class="lineNum">     471 </span>            :                                         accepted++;
<span class="lineNum">     472 </span>            :                                 }
<span class="lineNum">     473 </span>            :                         }
<span class="lineNum">     474 </span>            :                                 #endif
<span class="lineNum">     475 </span>            :                         /* update current tree and its stats */
<span class="lineNum">     476 </span><span class="lineCov">      51961 :                         len = lendash;</span>
<span class="lineNum">     477 </span><span class="lineCov">      51961 :                         SwapTrees(&amp;p_current_tree, &amp;root, &amp;p_proposed_tree, &amp;rootdash);</span>
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span>            :                         /* very best so far */
<span class="lineNum">     480 </span><span class="lineCov">      51961 :                         if (lendash &lt; lenbest) {</span>
<span class="lineNum">     481 </span><span class="lineCov">        509 :                                 lenbest = lendash;</span>
<span class="lineNum">     482 </span>            :                         #ifdef LVB_MAPREDUCE  
<span class="lineNum">     483 </span><span class="lineCov">        509 :                         MPI_Bcast(&amp;lenbest,  1, MPI_LONG, 0, MPI_COMM_WORLD);</span>
<span class="lineNum">     484 </span>            :                         #endif
<span class="lineNum">     485 </span>            :                         }
<span class="lineNum">     486 </span><span class="lineCov">      51961 :                         if (rcstruct.algorithm_selection == 1)</span>
<span class="lineNum">     487 </span><span class="lineCov">      51961 :                         changeAcc = 1;</span>
<span class="lineNum">     488 </span>            : 
<span class="lineNum">     489 </span>            :                 }
<span class="lineNum">     490 </span>            :                 else    /* poss. accept change for the worse */
<span class="lineNum">     491 </span>            :                 {
<span class="lineNum">     492 </span>            :                         if (rcstruct.algorithm_selection == 2)
<span class="lineNum">     493 </span>            :                         w_changes_prop ++; 
<span class="lineNum">     494 </span>            :                         /* Mathematically,
<span class="lineNum">     495 </span>            :                          *     Pacc = e ** (-1/T * deltaH)
<span class="lineNum">     496 </span>            :                          *     therefore ln Pacc = -1/T * deltaH
<span class="lineNum">     497 </span>            :                          *
<span class="lineNum">     498 </span>            :                          * Computationally, if Pacc is going to be small, we
<span class="lineNum">     499 </span>            :                          * can assume Pacc is 0 without actually working it
<span class="lineNum">     500 </span>            :                          * out.
<span class="lineNum">     501 </span>            :                          * i.e.,
<span class="lineNum">     502 </span>            :                          *     if ln Pacc &lt; ln eps, let Pacc = 0
<span class="lineNum">     503 </span>            :                          * substituting,
<span class="lineNum">     504 </span>            :                          *     if -deltaH / T &lt; ln eps, let Pacc = 0
<span class="lineNum">     505 </span>            :                          * rearranging,
<span class="lineNum">     506 </span>            :                          *     if -deltaH &lt; T * ln eps, let Pacc = 0
<span class="lineNum">     507 </span>            :                          * This lets us work out whether Pacc will be very
<span class="lineNum">     508 </span>            :                          * close to zero without dividing anything by T. This
<span class="lineNum">     509 </span>            :                          * should prevent overflow. Since T is no less
<span class="lineNum">     510 </span>            :                          * than eps and ln eps is going to have greater
<span class="lineNum">     511 </span>            :                          * magnitude than eps, underflow when calculating
<span class="lineNum">     512 </span>            :                          * T * ln eps is not possible. */
<span class="lineNum">     513 </span><span class="lineCov">     302089 :                         if (-deltah &lt; t * log_wrapper_LVB_EPS)</span>
<span class="lineNum">     514 </span>            :                         {
<span class="lineNum">     515 </span><span class="lineCov">     154342 :                                 pacc = 0.0;</span>
<span class="lineNum">     516 </span>            :                                 /* Call uni() even though its not required. It
<span class="lineNum">     517 </span>            :                                  * would have been called in LVB 1.0A, so this
<span class="lineNum">     518 </span>            :                                  * helps make results identical to results with
<span class="lineNum">     519 </span>            :                                  * that version. */
<span class="lineNum">     520 </span><span class="lineCov">     154342 :                                 (void) uni();</span>
<span class="lineNum">     521 </span>            :                         }
<span class="lineNum">     522 </span>            :                         else    /* possibly accept the change */
<span class="lineNum">     523 </span>            :                         {
<span class="lineNum">     524 </span><span class="lineCov">     147747 :                                 pacc = exp_wrapper(-deltah/t);</span>
<span class="lineNum">     525 </span><span class="lineCov">     147747 :                                 if (uni() &lt; pacc)    /* do accept the change */</span>
<span class="lineNum">     526 </span>            :                                 {
<span class="lineNum">     527 </span><span class="lineCov">      41547 :                                         SwapTrees(&amp;p_current_tree, &amp;root, &amp;p_proposed_tree, &amp;rootdash);</span>
<span class="lineNum">     528 </span>            :                                 if (rcstruct.algorithm_selection == 2)
<span class="lineNum">     529 </span>            :                                 w_changes_acc++; 
<span class="lineNum">     530 </span><span class="lineCov">      41547 :                                         len = lendash;</span>
<span class="lineNum">     531 </span><span class="lineCov">      41547 :                                         if (rcstruct.algorithm_selection == 1)</span>
<span class="lineNum">     532 </span><span class="lineCov">      41547 :                                         changeAcc = 1; </span>
<span class="lineNum">     533 </span>            :                                 }
<span class="lineNum">     534 </span>            :                         }
<span class="lineNum">     535 </span>            :                 }
<span class="lineNum">     536 </span><span class="lineCov">     354050 :                 proposed++;</span>
<span class="lineNum">     537 </span>            :                 #ifdef LVB_MAPREDUCE  
<span class="lineNum">     538 </span><span class="lineCov">     354050 :                 MPI_Bcast(&amp;proposed,  1, MPI_LONG, 0, MPI_COMM_WORLD);</span>
<span class="lineNum">     539 </span>            :                 #endif
<span class="lineNum">     540 </span>            : 
<span class="lineNum">     541 </span>            :                 
<span class="lineNum">     542 </span>            :                 /* decide whether to reduce temperature */
<span class="lineNum">     543 </span><span class="lineCov">     354050 :                 if (accepted &gt;= maxaccept){  /* enough new trees */</span>
<span class="lineNum">     544 </span>            :       
<span class="lineNum">     545 </span><span class="lineCov">        134 :                         failedcnt = 0;  /* this temperature a 'success' */</span>
<span class="lineNum">     546 </span><span class="lineCov">        134 :                         dect = LVB_TRUE;</span>
<span class="lineNum">     547 </span>            :                 }
<span class="lineNum">     548 </span><span class="lineCov">     353916 :                 else if (proposed &gt;= maxpropose){    /* enough proposals */</span>
<span class="lineNum">     549 </span><span class="lineCov">        164 :                         failedcnt++;</span>
<span class="lineNum">     550 </span>            :                         #ifdef LVB_MAPREDUCE  
<span class="lineNum">     551 </span><span class="lineCov">        164 :                         int check_stop = 0;</span>
<span class="lineNum">     552 </span><span class="lineCov">        164 :                                 if (misc-&gt;rank == 0 &amp;&amp; failedcnt &gt;= maxfail &amp;&amp; t &lt; FROZEN_T) check_stop = 1;</span>
<span class="lineNum">     553 </span><span class="lineCov">        164 :                                 MPI_Bcast(&amp;check_stop,  1, MPI_INT, 0, MPI_COMM_WORLD);</span>
<span class="lineNum">     554 </span><span class="lineCov">        164 :                                 if (check_stop == 1) {</span>
<span class="lineNum">     555 </span><span class="lineCov">          1 :                                         MPI_Bcast(&amp;failedcnt,  1, MPI_LONG, 0, MPI_COMM_WORLD);</span>
<span class="lineNum">     556 </span><span class="lineCov">          1 :                                         MPI_Bcast(&amp;t,  1, MPI_DOUBLE, 0, MPI_COMM_WORLD);</span>
<span class="lineNum">     557 </span>            :                                 }
<span class="lineNum">     558 </span>            :                         #endif
<span class="lineNum">     559 </span><span class="lineCov">        164 :                         if (failedcnt &gt;= maxfail &amp;&amp; t &lt; FROZEN_T) /* system frozen */</span>
<span class="lineNum">     560 </span>            :                         {
<span class="lineNum">     561 </span>            :                                 /* Preliminary experiments yielded that the freezing
<span class="lineNum">     562 </span>            :                                  * criterion used in previous versions of LVB is not
<span class="lineNum">     563 </span>            :                                  * suitable for the new version and regularly results
<span class="lineNum">     564 </span>            :                                  * in premature termination of the search. An easy fix
<span class="lineNum">     565 </span>            :                                  * is to only apply the freezing criterion in the
<span class="lineNum">     566 </span>            :                                  * temperature ranges of previous versions of LVB
<span class="lineNum">     567 </span>            :                                  * (LVB_EPS &lt; t &lt; 10^-4). Future work will look at optimising
<span class="lineNum">     568 </span>            :                                  * maxpropose, maxaccept and maxfail directly. */
<span class="lineNum">     569 </span>            :                                 break; /* end of cooling */
<span class="lineNum">     570 </span>            :                         }
<span class="lineNum">     571 </span>            :                         else{   /* system not frozen, so further decrease temp. */
<span class="lineNum">     572 </span><span class="lineCov">        163 :                                 dect = LVB_TRUE;</span>
<span class="lineNum">     573 </span>            :                         }
<span class="lineNum">     574 </span>            :                 }
<span class="lineNum">     575 </span>            : 
<span class="lineNum">     576 </span><span class="lineCov">     354049 :                 if (dect == LVB_TRUE)</span>
<span class="lineNum">     577 </span>            :                 {
<span class="lineNum">     578 </span><span class="lineCov">        297 :                         t_n++;  /* originally n is 0 */</span>
<span class="lineNum">     579 </span>            : 
<span class="lineNum">     580 </span><span class="lineCov">        297 :                         if (rcstruct.cooling_schedule == 0)  /* Geometric cooling */</span>
<span class="lineNum">     581 </span>            :                         {
<span class="lineNum">     582 </span>            :                                 /* Ensure t doesn't go out of bound */
<span class="lineNum">     583 </span><span class="lineCov">        297 :                                 ln_t = ((double) t_n) * log_wrapper_grad_geom + log_wrapper_t0;</span>
<span class="lineNum">     584 </span><span class="lineCov">        297 :                                 if (ln_t &lt; log_wrapper_LVB_EPS) t = LVB_EPS;</span>
<span class="lineNum">     585 </span><span class="lineCov">        297 :                                 else t = pow_wrapper(grad_geom, (double) t_n) * t0; /* decrease the temperature */</span>
<span class="lineNum">     586 </span><span class="lineCov">        297 :                 if (rcstruct.algorithm_selection == 1)</span>
<span class="lineNum">     587 </span>            :                 {
<span class="lineNum">     588 </span><span class="lineCov">        297 :         trops_probs[2] = t/t0;</span>
<span class="lineNum">     589 </span><span class="lineCov">        297 :         trops_probs[1] = (1 - trops_probs[2])/2;</span>
<span class="lineNum">     590 </span><span class="lineCov">        297 :         trops_probs[0] = trops_probs[1];</span>
<span class="lineNum">     591 </span>            :                 }
<span class="lineNum">     592 </span>            :                         }
<span class="lineNum">     593 </span>            :                         else /* Linear cooling */
<span class="lineNum">     594 </span>            :                         {
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :                                 t = t0 - grad_linear * t_n;</span>
<span class="lineNum">     596 </span>            :                                 /* Make sure t doesn't go out of bounce */
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :                                 if (t &lt; DBL_EPSILON || t &lt;= LVB_EPS) t = LVB_EPS;</span>
<span class="lineNum">     598 </span>            :                         }
<span class="lineNum">     599 </span><span class="lineCov">        297 :                         proposed = 0;</span>
<span class="lineNum">     600 </span><span class="lineCov">        297 :                         accepted = 0;</span>
<span class="lineNum">     601 </span><span class="lineCov">        297 :                         dect = LVB_FALSE;</span>
<span class="lineNum">     602 </span>            :                 #ifdef LVB_MAPREDUCE  
<span class="lineNum">     603 </span><span class="lineCov">        297 :                 MPI_Bcast(&amp;proposed,  1, MPI_LONG, 0, MPI_COMM_WORLD);</span>
<span class="lineNum">     604 </span><span class="lineCov">        297 :                 MPI_Bcast(&amp;accepted,  1, MPI_LONG, 0, MPI_COMM_WORLD);</span>
<span class="lineNum">     605 </span>            :                 #endif
<span class="lineNum">     606 </span>            :                 if (rcstruct.algorithm_selection == 2)
<span class="lineNum">     607 </span>            :                         { w_changes_prop = 0;
<span class="lineNum">     608 </span>            :         w_changes_acc = 0; 
<span class="lineNum">     609 </span>            :                         }
<span class="lineNum">     610 </span>            :                 }
<span class="lineNum">     611 </span>            : 
<span class="lineNum">     612 </span><span class="lineCov">     354049 :                 iter++;</span>
<span class="lineNum">     613 </span>            : 
<span class="lineNum">     614 </span>            :                 /* if (rcstruct.n_number_max_trees &gt; 0 &amp;&amp; bstackp-&gt;next &gt;= rcstruct.n_number_max_trees){
<span class="lineNum">     615 </span>            :                         break;
<span class="lineNum">     616 </span>            :                 } */
<span class="lineNum">     617 </span>            : 
<span class="lineNum">     618 </span><span class="lineCov">     354049 :         if (rcstruct.algorithm_selection == 2)</span>
<span class="lineNum">     619 </span>            :         {
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :         if (changeAcc == 1) {</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :             trops_counter[trops_id]++;</span>
<span class="lineNum">     622 </span>            :         }
<span class="lineNum">     623 </span>            :         else {
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :             for (int i=0; i &lt; 3; i++) {</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :              if (trops_id != i)</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :                 trops_counter[i] = trops_counter[i] + 0.5;</span>
<span class="lineNum">     627 </span>            :             }
<span class="lineNum">     628 </span>            :         }
<span class="lineNum">     629 </span>            :         }
<span class="lineNum">     630 </span><span class="lineCov">     354049 :         if (rcstruct.verbose == LVB_TRUE)</span>
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :         fprintf (pFile, &quot;%ld\t%s\t%d\t%ld\t%lf\t%ld\n&quot;, iter, change, changeAcc, len, t*10000, bstackp-&gt;next);</span>
<span class="lineNum">     632 </span>            :                 #ifdef LVB_MAPREDUCE  
<span class="lineNum">     633 </span><span class="lineCov">     354049 :                         MPI_Barrier(MPI_COMM_WORLD);</span>
<span class="lineNum">     634 </span>            : 
<span class="lineNum">     635 </span>            :             }
<span class="lineNum">     636 </span><span class="lineCov">          1 :             print_sets(MSA, bstackp, misc);</span>
<span class="lineNum">     637 </span>            :                 #else 
<span class="lineNum">     638 </span>            :     }
<span class="lineNum">     639 </span>            :                 #endif
<span class="lineNum">     640 </span>            : 
<span class="lineNum">     641 </span>            :     /* free &quot;local&quot; dynamic heap memory */
<span class="lineNum">     642 </span><span class="lineCov">          1 :         if (rcstruct.verbose == LVB_TRUE)</span>
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :         fclose(pFile);</span>
<span class="lineNum">     644 </span><span class="lineCov">          1 :     free_memory_to_getplen(&amp;p_todo_arr, &amp;p_todo_arr_sum_changes, &amp;p_runs);</span>
<span class="lineNum">     645 </span><span class="lineCov">          1 :     free(p_current_tree);</span>
<span class="lineNum">     646 </span><span class="lineCov">          1 :     free(p_proposed_tree);</span>
<span class="lineNum">     647 </span><span class="lineCov">          1 :     return lenbest;</span>
<span class="lineNum">     648 </span>            : 
<span class="lineNum">     649 </span>            : } /* end Anneal() */
<a name="650"><span class="lineNum">     650 </span>            : </a>
<span class="lineNum">     651 </span>            : #ifdef LVB_MAPREDUCE
<span class="lineNum">     652 </span><span class="lineCov">          1 : long getsoln(Dataptr restrict MSA, Parameters rcstruct, long *iter_p, Lvb_bool log_progress,</span>
<span class="lineNum">     653 </span>            :                                 MISC *misc, MapReduce *mrTreeStack, MapReduce *mrBuffer)
<span class="lineNum">     654 </span>            : #else
<span class="lineNum">     655 </span>            : long getsoln(Dataptr restrict MSA, Parameters rcstruct, long *iter_p, Lvb_bool log_progress)
<span class="lineNum">     656 </span>            : 
<span class="lineNum">     657 </span>            : #endif
<span class="lineNum">     658 </span>            : /* get and output solution(s) according to parameters in rcstruct;
<span class="lineNum">     659 </span>            :  * return length of shortest tree(s) found */
<span class="lineNum">     660 </span>            : {
<span class="lineNum">     661 </span>            :     static char fnam[LVB_FNAMSIZE];     /* current file name */
<span class="lineNum">     662 </span>            :     long fnamlen;                       /* length of current file name */
<span class="lineNum">     663 </span>            :     long i;                             /* loop counter */
<span class="lineNum">     664 </span>            :     double t0;          /* SA cooling cycle initial temp */
<span class="lineNum">     665 </span><span class="lineCov">          1 :     long maxaccept = MAXACCEPT_SLOW;    /* SA cooling cycle maxaccept */</span>
<span class="lineNum">     666 </span><span class="lineCov">          1 :     long maxpropose = MAXPROPOSE_SLOW;  /* SA cooling cycle maxpropose */</span>
<span class="lineNum">     667 </span><span class="lineCov">          1 :     long maxfail = MAXFAIL_SLOW;        /* SA cooling cycly maxfail */</span>
<span class="lineNum">     668 </span>            :     long treec;                         /* number of trees found */
<span class="lineNum">     669 </span><span class="lineCov">          1 :     long treelength = LONG_MAX;         /* length of each tree found */</span>
<span class="lineNum">     670 </span>            :     long initroot;                      /* initial tree's root */
<span class="lineNum">     671 </span>            :     FILE *sumfp;                        /* best length file */
<span class="lineNum">     672 </span>            :     FILE *resfp;                        /* results file */
<span class="lineNum">     673 </span>            :     TREESTACK_TREE_BRANCH *tree;                        /* initial tree */
<span class="lineNum">     674 </span>            :     Lvb_bit_length **enc_mat;   /* encoded data mat. */
<span class="lineNum">     675 </span>            :     long *p_todo_arr; /* [MAX_BRANCHES + 1];     list of &quot;dirty&quot; branch nos */
<span class="lineNum">     676 </span>            :     long *p_todo_arr_sum_changes; /*used in openMP, to sum the partial changes */
<span class="lineNum">     677 </span>            :     int *p_runs;                                /*used in openMP, 0 if not run yet, 1 if it was processed */
<span class="lineNum">     678 </span>            :         #ifdef LVB_MAPREDUCE
<span class="lineNum">     679 </span>            :         int *total_count;
<span class="lineNum">     680 </span>            :         #endif
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span>            :     /* NOTE: These variables and their values are &quot;dummies&quot; and are no longer
<span class="lineNum">     683 </span>            :      * used in the current version of LVB. However, in order to keep the
<span class="lineNum">     684 </span>            :      * formatting of the output compatible with that of previous versions of
<span class="lineNum">     685 </span>            :      * LVB these variables will continue to be used and written to the summary
<span class="lineNum">     686 </span>            :      * files.  */
<span class="lineNum">     687 </span><span class="lineCov">          1 :     long cyc = 0;       /* current cycle number */</span>
<span class="lineNum">     688 </span><span class="lineCov">          1 :     long start = 0;     /* current random (re)start number */</span>
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span>            :     /* dynamic &quot;local&quot; heap memory */
<span class="lineNum">     691 </span><span class="lineCov">          1 :     tree = treealloc(MSA, LVB_TRUE);</span>
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span>            :     /* Allocation of the initial encoded MSA is non-contiguous because
<span class="lineNum">     694 </span>            :      * this MSA isn't used much, so any performance penalty won't matter. */
<span class="lineNum">     695 </span><span class="lineCov">          1 :     enc_mat = (Lvb_bit_length **) malloc((MSA-&gt;n) * sizeof(Lvb_bit_length *));</span>
<span class="lineNum">     696 </span><span class="lineCov">        101 :     for (i = 0; i &lt; MSA-&gt;n; i++)</span>
<span class="lineNum">     697 </span><span class="lineCov">        100 :                 enc_mat[i] = (Lvb_bit_length *) alloc(MSA-&gt;bytes, &quot;state sets&quot;);</span>
<span class="lineNum">     698 </span><span class="lineCov">          1 :     DNAToBinary(MSA, enc_mat);</span>
<span class="lineNum">     699 </span>            : 
<span class="lineNum">     700 </span>            :     /* open and entitle statistics file shared by all cycles
<span class="lineNum">     701 </span>            :      * NOTE: There are no cycles anymore in the current version
<span class="lineNum">     702 </span>            :      * of LVB. The code bellow is purely to keep the output consistent
<span class="lineNum">     703 </span>            :      * with that of previous versions. */
<span class="lineNum">     704 </span>            : 
<span class="lineNum">     705 </span><span class="lineCov">          1 :     if (rcstruct.verbose == LVB_TRUE) {</span>
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :                 sumfp = clnopen(SUMFNAM, &quot;w&quot;);</span>
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :                 fprintf(sumfp, &quot;StartNo\tCycleNo\tCycInit\tCycBest\tCycTrees\n&quot;);</span>
<span class="lineNum">     708 </span>            :     }
<span class="lineNum">     709 </span>            :     else{
<span class="lineNum">     710 </span>            :         sumfp = NULL;
<span class="lineNum">     711 </span>            :     }
<span class="lineNum">     712 </span>            : 
<span class="lineNum">     713 </span>            :     /* determine starting temperature */
<span class="lineNum">     714 </span><span class="lineCov">          1 :     PullRandomTree(MSA, tree);  /* initialise required variables */</span>
<span class="lineNum">     715 </span><span class="lineCov">          1 :     ss_init(MSA, tree, enc_mat);</span>
<span class="lineNum">     716 </span><span class="lineCov">          1 :     initroot = 0;</span>
<span class="lineNum">     717 </span>            : 
<span class="lineNum">     718 </span><span class="lineCov">          1 :         t0 = StartingTemperature(MSA, tree, rcstruct, initroot, log_progress);</span>
<span class="lineNum">     719 </span>            : 
<span class="lineNum">     720 </span><span class="lineCov">          1 :     PullRandomTree(MSA, tree);  /* begin from scratch */</span>
<span class="lineNum">     721 </span><span class="lineCov">          1 :     ss_init(MSA, tree, enc_mat);</span>
<span class="lineNum">     722 </span><span class="lineCov">          1 :     initroot = 0;</span>
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span><span class="lineCov">          1 :     if (rcstruct.verbose) PrintStartMessage(start, cyc);</span>
<span class="lineNum">     725 </span><span class="lineCov">          1 :         CheckStandardOutput();</span>
<span class="lineNum">     726 </span>            : 
<span class="lineNum">     727 </span>            :     /* start cycles's entry in sum file
<span class="lineNum">     728 </span>            :      * NOTE: There are no cycles anymore in the current version
<span class="lineNum">     729 </span>            :      * of LVB. The code bellow is purely to keep the output consistent
<span class="lineNum">     730 </span>            :      * with that of previous versions.  */
<span class="lineNum">     731 </span>            : 
<span class="lineNum">     732 </span><span class="lineCov">          1 :     if(rcstruct.verbose == LVB_TRUE) {</span>
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :         alloc_memory_to_getplen(MSA, &amp;p_todo_arr, &amp;p_todo_arr_sum_changes, &amp;p_runs);</span>
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :                 fprintf(sumfp, &quot;%ld\t%ld\t%ld\t&quot;, start, cyc, getplen(MSA, tree, rcstruct, initroot, p_todo_arr, p_todo_arr_sum_changes, p_runs));</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :                 free_memory_to_getplen(&amp;p_todo_arr, &amp;p_todo_arr_sum_changes, &amp;p_runs);</span>
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :                 PrintInitialTree(MSA, tree, start, cyc, initroot);</span>
<span class="lineNum">     737 </span>            :     }
<span class="lineNum">     738 </span>            : 
<span class="lineNum">     739 </span>            :         #ifdef LVB_MAPREDUCE
<span class="lineNum">     740 </span><span class="lineCov">          1 :                 MPI_Barrier(MPI_COMM_WORLD);</span>
<span class="lineNum">     741 </span>            :                 /* find solution(s) */
<span class="lineNum">     742 </span>            :                 treelength = Anneal(MSA, &amp;bstack_overall, &amp;stack_treevo, tree, rcstruct, initroot, t0, maxaccept,
<span class="lineNum">     743 </span><span class="lineCov">          1 :                                 maxpropose, maxfail, stdout, iter_p, log_progress, misc, mrTreeStack, mrBuffer );</span>
<span class="lineNum">     744 </span>            : 
<span class="lineNum">     745 </span><span class="lineCov">          1 :                 long val = PullTreefromTreestack(MSA, tree, &amp;initroot, &amp;bstack_overall, LVB_FALSE);</span>
<span class="lineNum">     746 </span><span class="lineCov">          1 :                 CompareTreeToTreestack(MSA, &amp;bstack_overall, tree, initroot, LVB_FALSE);</span>
<span class="lineNum">     747 </span>            : 
<span class="lineNum">     748 </span><span class="lineCov">          1 :                 if(val ==  1) {</span>
<span class="lineNum">     749 </span><span class="lineCov">          1 :                         misc-&gt;SB = 0;</span>
<span class="lineNum">     750 </span><span class="lineCov">          1 :                         tree_setpush(MSA, tree, initroot, mrBuffer, misc);</span>
<span class="lineNum">     751 </span><span class="lineCov">          1 :                         mrTreeStack-&gt;add(mrBuffer);</span>
<span class="lineNum">     752 </span><span class="lineCov">          1 :                         mrTreeStack-&gt;collate(NULL);</span>
<span class="lineNum">     753 </span><span class="lineCov">          1 :                         mrTreeStack-&gt;reduce(reduce_filter, NULL);</span>
<span class="lineNum">     754 </span>            : 
<span class="lineNum">     755 </span><span class="lineCov">          1 :                         mrBuffer-&gt;add(mrTreeStack);</span>
<span class="lineNum">     756 </span><span class="lineCov">          1 :                         mrBuffer-&gt;collate(NULL);</span>
<span class="lineNum">     757 </span>            : 
<span class="lineNum">     758 </span><span class="lineCov">          1 :                         misc-&gt;count = (int *) alloc( (bstack_overall.next+1) * sizeof(int), &quot;integer array for tree compare using MapReduce&quot;);</span>
<span class="lineNum">     759 </span><span class="lineCov">          1 :                         total_count = (int *) alloc( (bstack_overall.next+1) * sizeof(int), &quot;integer array for tree compare using MapReduce&quot;);</span>
<span class="lineNum">     760 </span><span class="lineCov">         55 :                         for(int i=0; i&lt;=bstack_overall.next; i++) misc-&gt;count[i] = 0;</span>
<span class="lineNum">     761 </span><span class="lineCov">          1 :                         mrBuffer-&gt;reduce(reduce_count, misc);</span>
<span class="lineNum">     762 </span>            : 
<span class="lineNum">     763 </span><span class="lineCov">         55 :                         for(int i=0; i&lt;=bstack_overall.next; i++) total_count[i] = 0;</span>
<span class="lineNum">     764 </span><span class="lineCov">          1 :                         MPI_Reduce( misc-&gt;count, total_count, bstack_overall.next+1, MPI_INT, MPI_SUM, 0, MPI_COMM_WORLD );</span>
<span class="lineNum">     765 </span>            : 
<span class="lineNum">     766 </span><span class="lineCov">          1 :                         int check_cmp = 1;</span>
<span class="lineNum">     767 </span><span class="lineCov">          1 :                         if (misc-&gt;rank == 0) {</span>
<span class="lineNum">     768 </span><span class="lineCov">         54 :                                 for(int i=1; i&lt;=bstack_overall.next; i++) {</span>
<span class="lineNum">     769 </span><span class="lineCov">         54 :                                         if (misc-&gt;nsets == total_count[i]) {</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :                                                 check_cmp = 0; /* different */</span>
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :                                                 break;</span>
<span class="lineNum">     772 </span>            :                                         }
<span class="lineNum">     773 </span>            :                                 }
<span class="lineNum">     774 </span>            :                         }
<span class="lineNum">     775 </span>            : 
<span class="lineNum">     776 </span><span class="lineCov">          1 :                         MPI_Barrier(MPI_COMM_WORLD);</span>
<span class="lineNum">     777 </span><span class="lineCov">          1 :                         MPI_Bcast(&amp;check_cmp, 1, MPI_INT, 0,    MPI_COMM_WORLD);</span>
<span class="lineNum">     778 </span><span class="lineCov">          1 :                         if (check_cmp == 1) {</span>
<span class="lineNum">     779 </span><span class="lineCov">          1 :                           CompareTreeToTreestack(MSA, &amp;bstack_overall, tree, initroot, LVB_FALSE);</span>
<span class="lineNum">     780 </span><span class="lineCov">          1 :                           misc-&gt;ID = bstack_overall.next;</span>
<span class="lineNum">     781 </span><span class="lineCov">          1 :                                   misc-&gt;SB = 1;</span>
<span class="lineNum">     782 </span><span class="lineCov">          1 :                                   tree_setpush(MSA, tree, initroot, mrBuffer, misc);</span>
<span class="lineNum">     783 </span><span class="lineCov">          1 :                                   mrTreeStack-&gt;add(mrBuffer);</span>
<span class="lineNum">     784 </span>            :                         }
<span class="lineNum">     785 </span>            : 
<span class="lineNum">     786 </span><span class="lineCov">          1 :                         free(misc-&gt;count);</span>
<span class="lineNum">     787 </span><span class="lineCov">          1 :                         free(total_count);</span>
<span class="lineNum">     788 </span>            : 
<span class="lineNum">     789 </span>            :                         //treelength = deterministic_hillclimb(MSA, &amp;bstack_overall, tree, rcstruct, initroot, stdout,
<span class="lineNum">     790 </span>            :                         //      iter_p, log_progress, misc, mrTreeStack, mrBuffer);
<span class="lineNum">     791 </span>            :                 }
<span class="lineNum">     792 </span>            : 
<span class="lineNum">     793 </span>            :         #else
<span class="lineNum">     794 </span>            :             /* find solution(s) */
<span class="lineNum">     795 </span>            :     treelength = Anneal(MSA, &amp;bstack_overall, &amp;stack_treevo, tree, rcstruct, initroot, t0, maxaccept,
<span class="lineNum">     796 </span>            :     maxpropose, maxfail, stdout, iter_p, log_progress);
<span class="lineNum">     797 </span>            :     PullTreefromTreestack(MSA, tree, &amp;initroot, &amp;bstack_overall, LVB_FALSE);
<span class="lineNum">     798 </span>            : 
<span class="lineNum">     799 </span>            :         #ifdef LVB_HASH
<span class="lineNum">     800 </span>            :                 CompareHashTreeToHashstack(MSA, &amp;bstack_overall, tree, initroot, LVB_FALSE);
<span class="lineNum">     801 </span>            :         #else
<span class="lineNum">     802 </span>            :                 CompareTreeToTreestack(MSA, &amp;bstack_overall, tree, initroot, LVB_FALSE);
<span class="lineNum">     803 </span>            :         #endif
<span class="lineNum">     804 </span>            : 
<span class="lineNum">     805 </span>            :     //treelength = deterministic_hillclimb(MSA, &amp;bstack_overall, tree, rcstruct, initroot, stdout,
<span class="lineNum">     806 </span>            :         //                      iter_p, log_progress);
<span class="lineNum">     807 </span>            : 
<span class="lineNum">     808 </span>            :         #endif
<span class="lineNum">     809 </span>            : 
<span class="lineNum">     810 </span>            :         /* log this cycle's solution and its details
<span class="lineNum">     811 </span>            :          * NOTE: There are no cycles anymore in the current version
<span class="lineNum">     812 </span>            :      * of LVB. The code bellow is purely to keep the output consistent
<span class="lineNum">     813 </span>            :      * with that of previous versions. */
<span class="lineNum">     814 </span>            : 
<span class="lineNum">     815 </span><span class="lineCov">          1 :     if (rcstruct.verbose == LVB_TRUE){</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :                 fnamlen = sprintf(fnam, &quot;%s_start%ld_cycle%ld&quot;, RESFNAM, start, cyc);</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :                 lvb_assert(fnamlen &lt; LVB_FNAMSIZE);  /* really too late */</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :                 resfp = clnopen(fnam, &quot;w&quot;);</span>
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :                 treec = PrintTreestack(MSA, &amp;bstack_overall, resfp, LVB_FALSE);</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :                 clnclose(resfp, fnam);</span>
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :                 fprintf(sumfp, &quot;%ld\t%ld\n&quot;, treelength, treec);</span>
<span class="lineNum">     822 </span>            : 
<span class="lineNum">     823 </span>            :                 /* won't use length summary file until end of next cycle */
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :                 fflush(sumfp);</span>
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :                 if (ferror(sumfp)){</span>
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :                         crash(&quot;write error on file %s&quot;, SUMFNAM);</span>
<span class="lineNum">     827 </span>            :                 }
<span class="lineNum">     828 </span>            :     }
<span class="lineNum">     829 </span>            : 
<span class="lineNum">     830 </span>            : 
<span class="lineNum">     831 </span><span class="lineCov">          1 :     if (rcstruct.verbose == LVB_TRUE) // printf(&quot;Ending start %ld cycle %ld\n&quot;, start, cyc);</span>
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :     CheckStandardOutput();</span>
<span class="lineNum">     833 </span>            : 
<span class="lineNum">     834 </span><span class="lineCov">          1 :     if (rcstruct.verbose == LVB_TRUE) clnclose(sumfp, SUMFNAM);</span>
<span class="lineNum">     835 </span>            :     /* &quot;local&quot; dynamic heap memory */
<span class="lineNum">     836 </span><span class="lineCov">          1 :     free(tree);</span>
<span class="lineNum">     837 </span><span class="lineCov">          1 :         for (i = 0; i &lt; MSA-&gt;n; i++) free(enc_mat[i]);</span>
<span class="lineNum">     838 </span><span class="lineCov">          1 :     free(enc_mat);</span>
<span class="lineNum">     839 </span>            : 
<span class="lineNum">     840 </span><span class="lineCov">          1 :     return treelength;</span>
<span class="lineNum">     841 </span>            : 
<span class="lineNum">     842 </span>            : } /* end getsoln() */
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
